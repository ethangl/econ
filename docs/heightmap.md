# Heightmap Generation

## Cell Mesh

A jittered grid produces Voronoi cell centers. The Delaunay triangulation provides cell adjacency. Cell count and aspect ratio are configurable via `MapGenConfig`.

## Procedural DSL

Heightmaps are generated by executing a script of operations on a flat grid. Each operation modifies elevation in place. Elevation is stored as signed meters relative to sea level (`0m`), with `> 0m` as land.

### Operations

| Operation    | Effect                                   | Parameters            |
| ------------ | ---------------------------------------- | --------------------- |
| **Hill**     | BFS blob, height decays exponentially    | count, height, x%, y% |
| **Pit**      | Inverse blob (subtracts height)          | count, height, x%, y% |
| **Range**    | Mountain ridge between two random points | count, height, x%, y% |
| **Trough**   | Valley (inverse ridge)                   | count, height, x%, y% |
| **Strait**   | Water passage cutting through land       | width, direction      |
| **Mask**     | Distance-from-edge falloff (islands)     | fraction              |
| **Add**      | Add constant to heights                  | value, target         |
| **Multiply** | Scale heights                            | factor, target        |
| **Smooth**   | Average with neighbors                   | passes                |
| **Invert**   | Mirror heightmap                         | probability, axis     |

Ranges use `min-max` syntax (e.g. `20-30` = random in range). Percentages are 0-100 map coordinates.

### Key Algorithms

**Blob growth (Hill/Pit):** BFS flood fill from a random center. Height decays exponentially per step:

```
height[neighbor] = height[current] ^ blobPower * random(0.9, 1.1)
```

`blobPower` scales with cell count (~0.98 at 10k cells) to produce consistent blob sizes regardless of resolution.

**Linear features (Range/Trough):** Random walk from A to B with occasional deviations. Height decays outward from the ridge. Prominences extend downhill every ~6 cells.

**Mask:** `height *= (1 - nx^2) * (1 - ny^2)` â€” 1.0 at center, 0.0 at edges. Prevents land from touching map borders.

## Templates

9 predefined templates, each a DSL script producing a characteristic geography:

| Template      | Character                            |
| ------------- | ------------------------------------ |
| Volcano       | Central peak, radial slopes          |
| LowIsland     | Small landmass, low elevation        |
| Archipelago   | Scattered islands, lots of coastline |
| Continents    | Large landmasses with inland seas    |
| Pangea        | Single supercontinent                |
| HighIsland    | Mountainous island                   |
| Peninsula     | Land extending into water            |
| Shattered     | Fragmented terrain                   |
| OldWorld      | Multi-continent with straits         |

Same template + different seed = maps that feel related but are unique.

## Key Files

| File                                        | Purpose                       |
| ------------------------------------------- | ----------------------------- |
| `Assets/Scripts/MapGen/HeightmapTerrainOps.cs`    | DSL operation implementations |
| `Assets/Scripts/MapGen/HeightmapMeterDsl.cs`      | DSL parser                    |
| `Assets/Scripts/MapGen/HeightmapTemplates.cs`     | Canonical template scripts    |
| `Assets/Scripts/MapGen/HeightmapTemplateCompiler.cs` | Template resolution + tuning  |
